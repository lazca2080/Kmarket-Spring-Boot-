<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/productLayout}">
	<th:block layout:fragment="content"> 
	<script>
		let prodCount     = 0;
		let totalCount    = 0;
		let totalPrice    = 0;
		let totalDiscount = 0;
		let totalDelivery = 0;
		let totalPoint    = 0;
		let totalTotal    = 0;
		
		function totalChange(prodCount, totalPrice, totalPoint, totalTotal){
			document.querySelector('td[class=count]').innerText = prodCount.toLocaleString();
			document.querySelector('td[class=price]').innerText = totalPrice.toLocaleString();
			document.querySelector('td[class=delivery]').innerText = totalDelivery.toLocaleString();
			document.querySelector('td[class=point]').innerText = totalPoint.toLocaleString();
			document.querySelector('td[class=total]').innerText = totalTotal.toLocaleString();
			document.querySelector('td[class=discount]').innerText = (((totalPrice + totalDelivery) - totalTotal)).toLocaleString();
		}
		
		function checkProd(prodNo){
			if($('.'+prodNo).is(':checked')){
				prodCount     += 1;
				totalCount    += Number(document.getElementById(prodNo + 'count').innerText);
				totalPrice    += Number(document.getElementById(prodNo + 'price').innerText);
				totalDelivery += Number(document.getElementById(prodNo + 'delivery').innerText);
				totalPoint    += Number(document.getElementById(prodNo + 'point').innerText);
				totalTotal    += Number(document.getElementById(prodNo + 'total').innerText);
				
				totalChange(prodCount, totalPrice, totalPoint, totalTotal);
				
			}else if(!$('.'+prodNo).is(':checked')) {
				prodCount     -= 1;
				totalCount    -= Number(document.getElementById(prodNo + 'count').innerText);
				totalPrice    -= Number(document.getElementById(prodNo + 'price').innerText);
				totalDelivery -= Number(document.getElementById(prodNo + 'delivery').innerText);
				totalPoint    -= Number(document.getElementById(prodNo + 'point').innerText);
				totalTotal    -= Number(document.getElementById(prodNo + 'total').innerText);
				
				totalChange(prodCount, totalPrice, totalPoint, totalTotal);
			}
		}
	
		$(function(){
			
			var checkList = [];
			
			// 전체 선택
			$('input[name=all]').click(function(){
				checkList= [];
				$('input[name=prodNo]').attr('checked', true);
				
				$('input[name=prodNo]:checked').each(function(){
					checkList.push($(this).val());
				});
				
				$.ajax({
					url:'/Kmarket/product/cart/total',
					method:'POST',
					success: function(data){
						
					}
				});
			});
			
			// 선택 삭제
			$('.del').click(function(){
				checkList = [];
				$('input[name=prodNo]:checked').each(function(){
					checkList.push($(this).val());
				});
				
				let jsonData = { 'checkList' : checkList };
				let prodNo = JSON.stringify(jsonData);
				
				$.ajax({
					url:'/Kmarket/product/checkCart',
					method:'POST',
					data: jsonData,
					dataType:'JSON',
					success: function(data){
						
						if(checkList.length == data.result){
							alert('삭제 되었습니다.');
							location.href = "/Kmarket/product/cart";
						}else{
							alert('다시 시도해주세요.')
						}
					}
				});
			});
			
			$('.cart > form').submit(function(e){
				checkList = [];
				$('input[name=prodNo]:checked').each(function(){ checkList.push($(this).val()); });
				
				if(!$('input[name=prodNo]').is(':checked')){ alert('상품을 선택하세요'); }
				
				if(confirm('선택하신 상품으로 주문하시겠습니까?.')){
					
					$.ajax({
						url:'/Kmarket/product/order',
						method:'POST',
						data:{ 'checkList':checkList },
						dataType:'JSON',
						success: function(data){
							if(data.result == 1){
								location.href = "/Kmarket/product/order";
							}
						}
					});
				}
				e.preventDefault();
			});
		});
	
	</script>
            <section class="cart">
                <nav>
                    <h1>장바구니</h1>
                    <p>
                        HOME > 
                        <span>패션·의류·뷰티</span>
                         > 
                        <strong>장바구니</strong>
                    </p>
                </nav>
               <form action="#">
                    <table border="0">
                        <tr>
                            <th><input type="checkbox" name="all"></th>
                            <th>상품명</th>
                            <th>총수량</th>
                            <th>판매가</th>
                            <th>할인(%)</th>
                            <th>포인트</th>
                            <th>배송비</th>
                            <th>소계</th>
                        </tr>
                        <tr class="empty">
                            <td colspan="7">장바구니에 상품이 없습니다.</td>
                        </tr>
                        <tr th:each="prod:${prod}" th:id="${prod.prodNo}">
                            <td><input type="checkbox" th:class="${prod.prodNo}" name="prodNo" th:value="${prod.prodNo}" th:onclick="checkProd([[${prod.prodNo}]])"></td>
                            <td><article>
                                <a th:href="@{/product/view (prodNo=${prod.prodNo})}">
                                    <img th:src="@{/prodImg/__${prod.prodCate1}__/__${prod.prodCate2}__/__${prod.thumb2}__}" alt="1">
                                </a>
                                <div>
                                    <h2><a th:href="@{/product/view (prodNo=${prod.prodNo})}">[[${prod.prodName}]]</a></h2>
                                    <p>[[${prod.descript}]]</p>
                                </div>
                            </article></td>
                            <td th:id="${prod.prodNo + 'count'}">[[${prod.count}]]</td>
                            <td th:id="${prod.prodNo + 'price'}">[[${prod.price}]]</td>
                            <td th:id="${prod.prodNo + 'discount'}">[[${prod.discount}]]</td>
                            <td th:id="${prod.prodNo + 'point'}">[[${prod.point}]]</td>
                            <td th:id="${prod.prodNo + 'delivery'}">[[${prod.delivery}]]</td>
                            <td th:id="${prod.prodNo + 'total'}">[[${prod.total}]]</td>
                        </tr>
                    </table>
                    <input type="button" name="del" class='del' value="선택삭제">
                    <div class="total">
                        <h2>전체합계</h2>
                        <table>
                            <tr>
                                <td>상품수</td>
                                <td class='count'>0</td>
                            </tr>
                            <tr>
                                <td>상품금액</td>
                                <td class='price'>0</td>
                            </tr>
                            <tr>
                                <td>할인금액</td>
                                <td class='discount'>0</td>
                            </tr>
                            <tr>
                                <td>배송비</td>
                                <td class='delivery'>0</td>
                            </tr>
                            <tr>
                                <td>포인트</td>
                                <td class='point'>0</td>
                            </tr>
                            <tr>
                                <td>전체주문금액</td>
                                <td class='total'>0</td>
                            </tr>
                        </table>
                        <input type="submit" value="주문하기">
                    </div>
               </form>
            </section>
	</th:block>
</html>